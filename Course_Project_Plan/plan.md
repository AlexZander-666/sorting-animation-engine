# 系统性优化改进执行方案（plan.md）

> 项目：Sorting Animation Engine（Vite + React + TypeScript）  
> 适用目录：`Course_Project_Plan/`（按 `AGENTS.md` 约定保持根目录精简）  
> 目标：在不改变课程交付结构的前提下，对**性能、稳定性、可维护性、可用性、可测试性与交付质量**做系统性提升，并给出可落地的实施路径与验收标准。

---

## 0. 快速上下文（现状盘点）

### 0.1 技术栈与关键脚本
- 技术栈：Vite + React 19 + TypeScript，ESLint（flat config），Vitest（单测），Web Worker（Benchmark）。
- 脚本（`Course_Project_Plan/package.json`）：
  - `npm run dev`：开发预览
  - `npm run test`：单测（Vitest）
  - `npm run lint`：代码规范检查
  - `npm run build`：产物输出到 `release/dist/`
  - `npm run preview`：预览构建产物

### 0.2 架构分层（当前）
- `src/algorithms/*`：统一 `SortAlgorithm` 抽象 + `SortStep` 命令录制（compare/swap/overwrite/外排 I/O）。
- `src/components/*`：
  - `Dashboard.tsx`：数据输入、文件导入、算法选择、播控与速度/进度
  - `SortingVisualizer.tsx`：动画播放与外排视图渲染
  - `BenchmarkReport.tsx`：跑分（Worker 优先，主线程降级）+ 规则化“AI 评点”
- `src/context/*`：`SortingContext`（数据/配置）与 `VisualizerContext`（播放状态与控制接口）
- `src/utils/*`：阈值与输入清洗（`MAX_VISUAL_ELEMENTS=512`、`MAX_STEPS=200_000`、外排 `MEMORY_LIMIT=10`、Benchmark 阈值等）
- `doc/` & `res/`：报告、手册与截图（课程交付要求）

### 0.3 已具备的“护栏”
- 可视化上限：元素数 `MAX_VISUAL_ELEMENTS` 超限直接拦截并提示使用 Benchmark。
- 步骤上限：`MAX_STEPS` 防止动画录制导致页面卡死。
- Benchmark 阈值：O(n²) 与 O(n log n) 不同规模保护（并在评语中提示跳过原因）。
- 外排内存上限：`MEMORY_LIMIT=10`（概念演示用）并在超限时给出错误信息。

---

## 1. 优化目标（What）与衡量指标（How）

### 1.1 目标（按优先级）
- **P0 稳定性**：确保播放/暂停/拖拽/调速/重置在所有算法下行为一致、无竞态、无“看似生效但实际未生效”的状态错觉。
- **P0 性能**：512 元素可视化时保持可交互；高步数时拖拽/重放不造成明显长时间阻塞。
- **P1 可维护性**：模块边界清晰、类型约束更强、重复逻辑收敛；关键逻辑有测试兜底。
- **P1 体验与可用性**：信息展示更一致（算法名/状态/提示），错误与护栏提示更“可行动”。
- **P2 工程化与交付**：可重复构建；质量门禁（lint/test/build）清晰；文档与截图与实际功能保持一致。

### 1.2 指标（建议）
- 交互：播放中调速**1–2 步内生效**；拖拽到任意步骤**不出现错误状态**。
- 性能：512 元素、速度 20–100ms 时页面仍可响应；拖拽到 200k 步附近的“重放”耗时可接受（建议 <1s，或提供进度提示/降级策略）。
- 质量：`npm run lint`、`npm run test`、`npm run build` 全部通过；核心算法与护栏逻辑测试覆盖。

---

## 2. 工作流与里程碑（When）

> 如果时间紧：先完成 **M1（P0）**，再做 **M2（P1）**；M3/M4 属于加分项。

| 里程碑 | 周期（建议） | 目标 | 交付物 |
| --- | --- | --- | --- |
| M0 基线评估 | 0.5 天 | 明确当前体验/性能瓶颈与风险清单 | 本文“问题与改进点”勾选结果、基线记录 |
| M1 稳定性与性能 P0 | 1–2 天 | 修复高优先级问题，消除明显性能浪费 | 修复列表 + 回归检查清单 |
| M2 结构与质量 P1 | 2–4 天 | 重构与测试补齐，形成可持续迭代基础 | 新增/更新测试、关键模块重构说明 |
| M3 体验与一致性 P1 | 1–2 天 | UI/文案/展示一致性与可访问性 | UI 优化、提示文案、手册修订 |
| M4 交付打磨 P2 | 0.5–1 天 | 构建/文档/截图/发布流程收口 | `release/dist` 刷新、文档自洽、验收单 |

---

## 3. 优化改进清单（Backlog：按工作流拆解）

> 标注说明：**P0 必做 / P1 推荐 / P2 可选**；每项包含「动作」「产物」「验收」。

### A. 播放与可视化引擎（核心体验）

1) **P0：修复播放中调速不生效**
- 动作：将 `speed` 改为 `useRef`（或在 speed 变化时重置计时器），避免 `tick()` 闭包捕获旧值导致播放期调速无效。涉及 `src/components/SortingVisualizer.tsx`。
- 产物：调速实现方案 + 回归点（播放中拖动滑块）。
- 验收：播放过程中改变速度，下一轮 tick 使用新速度；无需“暂停再开始”。

2) **P0：优化柱状图 key，避免频繁重挂载**
- 动作：将 `<div key={`${value}-${index}`}>` 调整为稳定 key（建议仅 `index`），降低 diff/重建成本。涉及 `src/components/SortingVisualizer.tsx`。
- 产物：更稳定的 DOM 更新策略。
- 验收：交换/覆盖时仅高度样式变化，DOM 节点不被大规模重建（可用 React DevTools 观察或体感）。

3) **P0：播放循环可取消性增强**
- 动作：同时管理 `setTimeout` 与 `requestAnimationFrame` 的句柄；在 `pause/reset/unmount` 时明确 cancel，避免“暂停后仍触发一次 tick”。涉及 `src/components/SortingVisualizer.tsx`。
- 产物：更严格的计时器清理逻辑。
- 验收：快速点击开始/暂停/重置不会出现步数跳动或状态错乱。

4) **P1：拖拽 seek 性能优化（checkpoint/snapshot）**
- 动作：为 `steps` 引入快照（如每 500/1000 步保存一次 array/externalState），seek 时从最近快照回放，避免 O(n) 全量重放导致卡顿。
- 产物：`Visualizer` 内部快照结构与内存评估（snapshot 数量 * 512 * 8B）。
- 验收：接近 200k 步时拖拽仍可用；必要时提供“拖拽处理中…”提示与降级策略（例如限制拖拽频率）。

5) **P1：高频 compare 步骤的批处理**
- 动作：当 step 为 `compare` 时，可以在一个渲染帧内批量消费多步（例如最多 N 步或最多 Xms），减少 React setState 频率。
- 产物：批处理策略参数（N、Xms）与体验权衡说明。
- 验收：高步数算法（如冒泡）在较快速度下更顺滑，CPU 占用下降。

6) **P2：可视化模式“渐进渲染”**
- 动作：为大数组显示提供降采样（例如仅绘制 1/2 或 1/4 的柱子并注明“降采样预览”），与 Benchmark 形成更清晰分工。
- 验收：超大数据也能给出可视化直觉，同时不违反护栏（仍不播放完整动画）。

### B. 外部排序视图（可解释性与一致性）

1) **P0：修正 winner/candidate 高亮逻辑**
- 动作：外排视图中区分“候选块”与“胜出块”，避免冗余条件与错误高亮；可新增样式类（candidate/winner）。涉及 `src/components/SortingVisualizer.tsx` 与 `src/App.css`。
- 验收：多路归并时，候选块与最终胜出块高亮符合 `comparisonDetails` 的语义。

2) **P1：补充“输出块”与“内存占用”展示**
- 动作：把 output chunk（`chunkId = chunks.length`）在 UI 中命名为“输出块”，并显示当前写入位置；对 `memoryChunk.data.length` 与 `MEMORY_LIMIT` 做可视化（如进度条）。
- 验收：外排过程更易理解；错误提示与展示一致。

3) **P2：更真实的外排步骤模型**
- 动作：将多路归并阶段按“块加载（满 10）→ 内存比较 → 写回输出缓冲”更细致地建模（与课程讲义更贴合），并在文档中注明“浏览器演示模型”。
- 验收：步骤更贴近外排概念；性能仍可控（必要时限步或限量展示）。

### C. Benchmark 与 Worker（性能、可靠性、可解释性）

1) **P0：Benchmark 任务的可取消与防抖**
- 动作：在触发新 Benchmark 时取消旧任务（Worker 端可通过 jobId 早停或直接重建 worker）；按钮增加“运行中禁止重复触发/支持取消”。
- 验收：连续多次点击不会堆积后台任务；结果不会被旧任务覆盖或延迟刷屏。

2) **P1：结果可信度增强（多次运行/统计量）**
- 动作：对每个算法运行多次（例如 3–5 次），输出 median/avg/std；避免单次噪声（JIT/GC/系统负载）误导。
- 验收：同一数据集下结果更稳定；表格展示更专业。

3) **P1：Benchmark 进度条与阶段提示**
- 动作：Worker 逐个算法回传中间结果（或回传进度），UI 显示进度与当前运行算法。
- 验收：大数据时用户知道“正在做什么”，减少误判为卡死。

4) **P2：数据传输优化**
- 动作：对大数组采用“Worker 内生成数据/或传递种子”替代整数组 structured clone；或使用 `postMessage` 分片策略（视需求而定）。
- 验收：Benchmark 触发的 UI 阻塞更少。

### D. 数据输入与可配置性（易用、可控、可扩展）

1) **P0：输入范围与文案一致性**
- 动作：当前 `MIN_VALUE=5` 会把 0/负数钳制为 5（为了柱状图可见性）。需要在 UI/手册中明确原因；或提供“允许 0/负数”的开关（默认仍保留护栏）。
- 验收：用户不会误以为“数据被吞”；测试描述与实际行为一致。

2) **P1：提供数据分布预设**
- 动作：新增“近乎有序/逆序/大量重复/少量离群值”等预设生成器（`src/utils/data.ts`），用于教学对比（尤其快速排序最坏情况）。
- 验收：无需手工输入即可演示不同分布下算法差异。

3) **P2：导入大文件的流式解析**
- 动作：对接近 10MB 的文件采用分片读取（FileReader slice）或 Web Worker 解析，避免主线程卡顿。
- 验收：大文件导入体验更平滑。

### E. 代码结构与类型治理（可维护性）

1) **P1：拆分 Visualizer 为 hook + 纯渲染组件**
- 动作：把播放状态机（steps、seek、tick、timer）收敛到 `useSortingPlayback()`；UI 部分保持尽量纯。
- 验收：`SortingVisualizer.tsx` 复杂度下降；可独立测试核心逻辑。

2) **P1：收敛“算法展示名”来源**
- 动作：把中文名/英文名/slug 的映射放到单一位置（如 `src/utils/labels.ts`），Dashboard/Visualizer/Benchmark 复用，避免不一致。
- 验收：所有位置展示一致；未来新增算法只改一处。

3) **P2：上下文职责简化**
- 动作：评估 `SortingContext.mode` 是否需要（当前未被使用）；要么补齐“模式切换”能力，要么移除以减少认知负担。
- 验收：context 字段都“有用且被用”，避免配置漂移。

### F. 测试体系与质量门禁（可回归、可持续）

1) **P0：补齐关键回归测试**
- 动作：围绕以下场景补测（Vitest）：
  - 各算法 `run(true)` / `run(false)` 结果一致（已存在，可扩展随机样本）
  - 步数上限 `MAX_STEPS` 保护（已存在）
  - 外排内存限制与 chunk 行为（已存在，可扩展）
  - 输入解析：逗号/空格/换行、0/负数、异常 token（已有，可修正文案并扩展）
- 验收：改动可视化/算法后能快速发现回归。

2) **P1：组件级测试（可选引入 RTL）**
- 动作：若允许新增依赖，引入 React Testing Library，覆盖：
  - Dashboard：输入应用、导入错误提示、超限提示
  - Benchmark：Worker 不可用降级提示、跳过策略提示
- 验收：核心 UI 行为可自动化验证。

3) **P2：性能/交互回归脚本**
- 动作：补充简单的“基线脚本/手动检查表”（不一定自动化）：
  - 512 元素播放、调速、拖拽、切算法、Benchmark 并行等。
- 验收：每次发布前一键/一页即可完成回归。

### G. 文档、交付与工程化（面向验收）

1) **P0：刷新与统一审查报告**
- 动作：将 `doc/Audit_Report.md` 标注为“历史版本”或更新为“与当前代码一致”的版本；避免过时内容误导。
- 验收：`doc/` 内文档相互引用不冲突，读者不会被误导。

2) **P1：补充“开发者指南”**
- 动作：在 `Course_Project_Plan/README.md` 增加：
  - 如何新增算法（`SortingAlgorithmType` + 工厂 + `SortAlgorithm` 子类）
  - `SortStep` 语义表
  - 护栏参数说明与调参建议
- 验收：新同学能在 10 分钟内上手扩展算法并跑通测试。

3) **P1：CI（若项目托管到 Git）**
- 动作：增加 GitHub Actions（或等效）执行 `lint/test/build`，并校验 `release/dist` 产物生成。
- 验收：每次 push/PR 自动把关，减少“最后一天才发现 build 失败”。

4) **P2：可访问性与响应式改进**
- 动作：增加键盘可操作性、ARIA 标签、对比度与小屏布局优化；为进度条与按钮提供可读文本。
- 验收：基本符合可访问性最佳实践，移动端也能完成主要操作。

---

## 4. 执行顺序建议（最小可行路径）

### 4.1 如果只做 1 天（冲刺版）
1. 修复播放中调速不生效（A-1）
2. 优化柱状图 key（A-2）
3. Benchmark 可取消/防抖（C-1）
4. 刷新过时审查文档（G-1）
5. 跑通 `npm run lint` / `npm run test` / `npm run build`

### 4.2 如果有 3–5 天（标准版）
在冲刺版基础上补齐：
- seek 快照（A-4）
- 外排高亮与输出块优化（B-1/B-2）
- 统一算法展示名（E-2）
- 组件测试或关键 UI 行为测试（F-2 任选）
- README 开发者指南（G-2）

---

## 5. 验收清单（Definition of Done）

### 5.1 命令级（必须）
- `npm install`
- `npm run lint`
- `npm run test`
- `npm run build`（`release/dist/` 成功生成）
- `npm run preview`（可选但推荐）

### 5.2 功能级（手工回归）
- 可视化：开始/暂停/重置/拖拽到任意步骤均正常；播放中调速立即生效；切换算法/切换数据后状态正确。
- 护栏：>512 元素提示明确且不播放；步数超限提示明确；文件 >10MB 提示明确。
- Benchmark：Worker 可用时不阻塞 UI；不可用时提示降级；阈值跳过与评语一致。
- 外排：内存上限提示与视图一致；候选/胜出块高亮正确。

---

## 6. 风险与应对

| 风险 | 触发点 | 影响 | 应对 |
| --- | --- | --- | --- |
| seek 快照占用内存 | 快照间隔过小 | 浏览器内存升高 | 评估快照间隔（500/1000/2000），必要时仅保存 TypedArray 或仅保存关键帧 |
| 批处理导致动画不“逐步可见” | compare 步骤过多 | 教学观感变化 | 仅对 compare 批处理；swap/overwrite 仍逐步渲染；提供开关 |
| Worker 兼容性差异 | 老浏览器/安全策略 | Benchmark 降级 | 保持阈值保护；UI 明示降级；提供取消 |
| 结果不稳定 | 单次测量噪声 | 评语误导 | 多次运行取中位数/平均值；记录波动 |

---

## 7. 附：推荐的变更管理方式

- 每次改动尽量“小步快跑”：一个 PR/提交只解决一个主题（例如“播放调速修复”）。
- 每个主题都写清楚：改动点、验证方式（命令 + 手工）、风险回滚方案。
- 对外行为变更（例如允许 0/负数）务必同步更新：
  - `Course_Project_Plan/README.md`
  - `Course_Project_Plan/doc/User_Manual.md`
  - `Course_Project_Plan/Detailed_Prompts.md`（若影响评语/护栏）
