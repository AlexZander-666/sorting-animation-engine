(function(){"use strict";const g={Bubble:"bubble",Selection:"selection",Insertion:"insertion",Quick:"quick",Merge:"merge",Heap:"heap",ExternalMerge:"externalMerge"},C=2e5,S=10;class y{array;steps=[];comparisons=0;swaps=0;startTime=0;duration=0;auxiliarySpace=0;constructor(t){this.array=[...t]}run(t){return this.reset(t),this.sort(t),this.duration=performance.now()-this.startTime,t?this.steps:[]}getStats(){return{algorithmName:this.constructor.name,comparisons:this.comparisons,swaps:this.swaps,executionTime:this.duration,memoryUsage:this.array.length*8+this.auxiliarySpace}}reset(t){this.steps=t?[]:this.steps,this.comparisons=0,this.swaps=0,this.startTime=performance.now(),this.auxiliarySpace=0}ensureCapacity(t){if(t&&this.steps.length>=C)throw new Error(`动画步骤数量超过限制 (${C})，请减小输入规模。`)}pushStep(t,e){e&&(this.ensureCapacity(!0),this.steps.push(t))}compare(t,e,s){return this.comparisons++,this.pushStep({type:"compare",indices:[t,e]},s),this.array[t]-this.array[e]}swap(t,e,s){this.swaps++,this.pushStep({type:"swap",indices:[t,e]},s);const r=this.array[t];this.array[t]=this.array[e],this.array[e]=r}overwrite(t,e,s){this.swaps++,this.pushStep({type:"overwrite",index:t,value:e},s),this.array[t]=e}getArraySnapshot(){return[...this.array]}}class k extends y{sort(t){const e=this.array.length;for(let s=0;s<e-1;s+=1)for(let r=0;r<e-s-1;r+=1)this.compare(r,r+1,t)>0&&this.swap(r,r+1,t)}}class I extends y{MEMORY_CAPACITY=S;sort(t){if(this.array.length===0)return;const e=this.MEMORY_CAPACITY,s=[];for(let a=0;a<this.array.length;a+=e){const i=this.array.slice(a,a+e);this.ensureMemoryCapacity(i.length),s.push(i)}this.auxiliarySpace=Math.max(this.auxiliarySpace,this.MEMORY_CAPACITY*8),this.pushStep({type:"splitToChunks",chunks:s.map(a=>[...a])},t);const r=s.map((a,i)=>{this.pushStep({type:"loadChunkToMemory",chunkId:i,data:[...a]},t);const n=[...a].sort((o,p)=>(this.comparisons++,o-p));return this.ensureMemoryCapacity(n.length),n.forEach((o,p)=>{this.pushStep({type:"writeToDisk",chunkId:i,index:p,value:o},t)}),n});this.multiWayMerge(r,t)}ensureMemoryCapacity(t){if(t>this.MEMORY_CAPACITY)throw new Error(`单个数据块大小 (${t}) 超出内存缓冲区上限 ${this.MEMORY_CAPACITY}，请减少输入规模。`)}multiWayMerge(t,e){const s=new Array(t.length).fill(0),r=t.reduce((i,n)=>i+n.length,0),a=t.length;for(let i=0;i<r;i+=1){let n=-1,o=1/0;const p=[];if(t.forEach((w,f)=>{if(s[f]<w.length){const M=w[s[f]];p.push(f),this.comparisons++,M<o&&(o=M,n=f)}}),n===-1)break;this.pushStep({type:"loadChunkToMemory",chunkId:n,data:[t[n][s[n]]]},e),this.pushStep({type:"comparisonDetails",indices:p,winnerIndex:n},e),this.pushStep({type:"writeToDisk",chunkId:a,index:i,value:o},e),this.overwrite(i,o,e),s[n]+=1}}}class A extends y{sort(t){const e=this.array.length;for(let s=Math.floor(e/2)-1;s>=0;s-=1)this.heapify(e,s,t);for(let s=e-1;s>0;s-=1)this.swap(0,s,t),this.heapify(s,0,t)}heapify(t,e,s){let r=e;const a=2*e+1,i=2*e+2;a<t&&this.compare(a,r,s)>0&&(r=a),i<t&&this.compare(i,r,s)>0&&(r=i),r!==e&&(this.swap(e,r,s),this.heapify(t,r,s))}}class d extends y{sort(t){for(let e=1;e<this.array.length;e+=1){let s=e;for(;s>0&&this.compare(s-1,s,t)>0;)this.swap(s-1,s,t),s-=1}}}class Y extends y{sort(t){this.array.length<=1||this.mergeSort(0,this.array.length-1,t)}mergeSort(t,e,s){if(t>=e)return;const r=Math.floor((t+e)/2);this.mergeSort(t,r,s),this.mergeSort(r+1,e,s),this.merge(t,r,e,s)}merge(t,e,s,r){const a=[];let i=t,n=e+1;for(;i<=e&&n<=s;)this.compare(i,n,r)<=0?(a.push(this.array[i]),i+=1):(a.push(this.array[n]),n+=1);for(;i<=e;)a.push(this.array[i]),i+=1;for(;n<=s;)a.push(this.array[n]),n+=1;this.auxiliarySpace=Math.max(this.auxiliarySpace,a.length*8),a.forEach((o,p)=>{this.overwrite(t+p,o,r)})}}class v extends y{sort(t){this.quickSort(0,this.array.length-1,t)}quickSort(t,e,s){if(t<e){const r=this.partition(t,e,s);this.quickSort(t,r-1,s),this.quickSort(r+1,e,s)}}partition(t,e,s){const r=e;let a=t-1;for(let i=t;i<e;i+=1)this.compare(i,r,s)<=0&&(a+=1,this.swap(a,i,s));return this.swap(a+1,e,s),a+1}}class P extends y{sort(t){const e=this.array.length;for(let s=0;s<e-1;s+=1){let r=s;for(let a=s+1;a<e;a+=1)this.compare(a,r,t)<0&&(r=a);r!==s&&this.swap(s,r,t)}}}const R=(l,t)=>{switch(l){case g.Bubble:return new k(t);case g.Selection:return new P(t);case g.Insertion:return new d(t);case g.Quick:return new v(t);case g.Merge:return new Y(t);case g.Heap:return new A(t);case g.ExternalMerge:default:return new I(t)}};self.onmessage=l=>{const{jobId:t,jobs:e,runCount:s=3}=l.data,r=[];e.forEach((i,n)=>{const o=[];for(let m=0;m<s;m+=1){const c=(()=>{try{const h=R(i.algorithm,i.data);return h.run(!1),{...h.getStats(),algorithmType:i.algorithm}}catch(h){return{algorithmName:i.algorithm,comparisons:0,swaps:0,executionTime:0,memoryUsage:0,algorithmType:i.algorithm,error:h instanceof Error?h.message:"未知错误",skipped:!0}}})();o.push(c)}const p=m=>m.reduce((c,h)=>c+h,0)/m.length,w=m=>{const c=[...m].sort((x,T)=>x-T),h=Math.floor(c.length/2);return c.length%2===0?(c[h-1]+c[h])/2:c[h]},f=(()=>{if(o.some(u=>u.error)){const u=o.find(O=>O.error);return{algorithmName:i.algorithm,comparisons:0,swaps:0,executionTime:0,executionTimeAverage:0,executionTimeMedian:0,memoryUsage:0,algorithmType:i.algorithm,runs:s,error:u?.error??"未知错误",skipped:!0}}const c=o.map(u=>u.executionTime),h=o.map(u=>u.comparisons),x=o.map(u=>u.swaps),T=o.map(u=>u.memoryUsage),E=p(c),_=w(c);return{algorithmName:i.algorithm,comparisons:p(h),swaps:p(x),executionTime:E,executionTimeAverage:E,executionTimeMedian:_,memoryUsage:Math.max(...T),algorithmType:i.algorithm,runs:s}})();r.push(f);const M={jobId:t,type:"progress",progress:n+1,total:e.length,result:f};self.postMessage(M)});const a={jobId:t,type:"complete",results:r};self.postMessage(a)}})();
